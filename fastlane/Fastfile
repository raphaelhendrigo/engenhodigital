default_platform(:android)

platform :android do
  desc "Sync Play Store listing (metadata/images/screenshots) without uploading a binary"
  lane :sync_listing do
    metadata_path = File.expand_path(File.join(__dir__, "metadata/android"))
    has_metadata = Dir.exist?(metadata_path)
    unless has_metadata
      UI.message("No fastlane metadata found at #{metadata_path}. Skipping store listing sync.")
      next
    end

    # `supply` currently requires a track/release context even when only syncing listing assets.
    # Defaulting to `production` can crash when production has no releases yet; use `internal` which
    # exists for new apps once the first internal test build is uploaded.
    #
    # Note: store listing is app-wide, not track-specific.
    track = ENV["PLAY_LISTING_TRACK"] || "internal"

    supply(
      json_key: ENV.fetch("PLAY_JSON_KEY_PATH"),
      package_name: ENV.fetch("PLAY_PACKAGE_NAME"),
      track: track,
      metadata_path: metadata_path,
      # Listing sync only
      skip_upload_apk: true,
      skip_upload_aab: true,
      skip_upload_changelogs: true,
      skip_upload_metadata: false,
      skip_upload_images: false,
      skip_upload_screenshots: false
    )
  end

  desc "Upload signed AAB to Google Play (track via PLAY_TRACK, default internal)"
  lane :upload do
    aab_path = ENV.fetch("AAB_PATH")
    track = ENV["PLAY_TRACK"] || "internal"
    release_status = ENV["PLAY_RELEASE_STATUS"] || "completed"
    metadata_path = File.expand_path(File.join(__dir__, "metadata/android"))

    # If the upload key was recently reset in Play Console, Google can temporarily reject uploads
    # with: "The upload certificate ... is not yet valid because it has been recently reset."
    # This retry avoids manual reruns during that one-time propagation window.
    max_attempts = Integer(ENV.fetch("PLAY_UPLOAD_KEY_RESET_MAX_ATTEMPTS", "12"))
    sleep_seconds = Integer(ENV.fetch("PLAY_UPLOAD_KEY_RESET_SLEEP_SECONDS", "300"))
    error_marker = "upload certificate this APK is signed with is not yet valid because it has been recently reset"

    attempt = 1
    begin
      upload_to_play_store(
        aab: aab_path,
        track: track,
        release_status: release_status,
        json_key: ENV.fetch("PLAY_JSON_KEY_PATH"),
        package_name: ENV.fetch("PLAY_PACKAGE_NAME"),
        metadata_path: metadata_path,
        # Store listing is synced via `sync_listing` above. Keep binary upload focused.
        skip_upload_metadata: true,
        skip_upload_images: true,
        skip_upload_screenshots: true,
        # Release notes are uploaded via changelogs/<version_code>.txt (generated by CI).
        skip_upload_changelogs: false
      )
    rescue StandardError => e
      msg = (e.message || "").downcase
      if msg.include?(error_marker)
        if attempt < max_attempts
          UI.important(
            "Play upload key reset still propagating. Waiting #{sleep_seconds}s before retrying " \
            "(attempt #{attempt + 1}/#{max_attempts})."
          )
          sleep(sleep_seconds)
          attempt += 1
          retry
        end

        UI.important(
          "Play is still rejecting AAB uploads due to a recent upload key reset. " \
          "This is a Play Console propagation delay. Wait and rerun the workflow later."
        )
      end
      raise
    end
  end

  desc "Upload signed AAB to internal track"
  lane :internal do
    ENV["PLAY_TRACK"] = "internal"
    upload
  end

  desc "Upload signed AAB to production track"
  lane :production do
    ENV["PLAY_TRACK"] = "production"
    upload
  end

  desc "Promote an existing track release to production (safe default: internal -> production)"
  lane :promote_to_production do
    from_track = ENV["PLAY_TRACK"] || "internal"
    promote_status = ENV["PLAY_PROMOTE_RELEASE_STATUS"] || (ENV["PLAY_RELEASE_STATUS"] || "completed")

    supply(
      json_key: ENV.fetch("PLAY_JSON_KEY_PATH"),
      package_name: ENV.fetch("PLAY_PACKAGE_NAME"),
      track: from_track,
      track_promote_to: "production",
      track_promote_release_status: promote_status,
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true
    )
  end
end
