default_platform(:android)

platform :android do
  desc "Sync Play Store listing (metadata/images/screenshots) without uploading a binary"
  lane :sync_listing do
    metadata_path = File.expand_path(File.join(__dir__, "metadata/android"))
    has_metadata = Dir.exist?(metadata_path)
    unless has_metadata
      UI.message("No fastlane metadata found at #{metadata_path}. Skipping store listing sync.")
      next
    end

    # `supply` currently requires a track/release context even when only syncing listing assets.
    # Defaulting to `production` can crash when production has no releases yet; use `internal` which
    # exists for new apps once the first internal test build is uploaded.
    #
    # Note: store listing is app-wide, not track-specific.
    track = ENV["PLAY_LISTING_TRACK"] || "internal"

    supply(
      json_key: ENV.fetch("PLAY_JSON_KEY_PATH"),
      package_name: ENV.fetch("PLAY_PACKAGE_NAME"),
      track: track,
      metadata_path: metadata_path,
      # Listing sync only
      skip_upload_apk: true,
      skip_upload_aab: true,
      skip_upload_changelogs: true,
      skip_upload_metadata: false,
      skip_upload_images: false,
      skip_upload_screenshots: false
    )
  end

  desc "Upload signed AAB to Google Play (track via PLAY_TRACK, default internal)"
  lane :upload do
    aab_path = ENV.fetch("AAB_PATH")
    track = ENV["PLAY_TRACK"] || "internal"
    release_status = ENV["PLAY_RELEASE_STATUS"] || "completed"
    metadata_path = File.expand_path(File.join(__dir__, "metadata/android"))
    sync_listing = ENV.fetch("PLAY_SYNC_LISTING", "true").to_s.strip.downcase != "false"
    if sync_listing && !Dir.exist?(metadata_path)
      UI.important("PLAY_SYNC_LISTING is enabled, but no fastlane metadata found at #{metadata_path}. Skipping listing sync.")
      sync_listing = false
    end

    # Some brand-new apps remain in "draft" state in Play Console until the one-time onboarding is complete.
    # In that state, Play rejects non-draft releases via API with:
    # "Only releases with status draft may be created on draft app."
    draft_app_marker = "only releases with status draft may be created on draft app"

    # When Play expects a different upload key certificate, it rejects the upload with:
    # "The Android App Bundle was signed with the wrong key. Found: SHA1: ... expected: SHA1: ..."
    wrong_key_marker = "the android app bundle was signed with the wrong key"

    # If the upload key was recently reset in Play Console, Google can temporarily reject uploads
    # with: "The upload certificate ... is not yet valid because it has been recently reset."
    # This retry avoids manual reruns during that one-time propagation window.
    max_attempts = Integer(ENV.fetch("PLAY_UPLOAD_KEY_RESET_MAX_ATTEMPTS", "12"))
    sleep_seconds = Integer(ENV.fetch("PLAY_UPLOAD_KEY_RESET_SLEEP_SECONDS", "300"))
    error_marker = "upload certificate this apk is signed with is not yet valid because it has been recently reset"

    effective_release_status = release_status
    did_retry_as_draft = false
    attempt = 1
    begin
      upload_to_play_store(
        aab: aab_path,
        track: track,
        release_status: effective_release_status,
        json_key: ENV.fetch("PLAY_JSON_KEY_PATH"),
        package_name: ENV.fetch("PLAY_PACKAGE_NAME"),
        metadata_path: metadata_path,
        # Store listing assets (title/description/icon/screenshots) are synced from fastlane/metadata.
        skip_upload_metadata: !sync_listing,
        skip_upload_images: !sync_listing,
        skip_upload_screenshots: !sync_listing,
        # Release notes are uploaded via changelogs/<version_code>.txt (generated by CI).
        skip_upload_changelogs: false
      )
    rescue StandardError => e
      raw = e.message || ""
      msg = raw.downcase
      if msg.include?(draft_app_marker) && !did_retry_as_draft && effective_release_status.to_s.downcase != "draft"
        UI.important(
          "Play Console reports this app is still in DRAFT state. Retrying upload as release_status=draft.\n" \
          "ONE-TIME: after you roll out at least one release in Play Console (and complete required forms), " \
          "future CI uploads can use release_status=completed."
        )
        effective_release_status = "draft"
        did_retry_as_draft = true
        retry
      end
      if msg.include?(wrong_key_marker)
        found = nil
        expected = nil
        # Example: "Found: SHA1: .., expected: SHA1: .."
        m = raw.match(/Found:\s*SHA1:\s*([0-9A-F:]+),\s*expected:\s*SHA1:\s*([0-9A-F:]+)/i)
        if m
          found = m[1]
          expected = m[2]
        end

        UI.important(
          "Play rejected this upload due to an UPLOAD KEY mismatch.\n" \
          "Expected upload cert SHA1: #{expected || '(unknown)'}\n" \
          "CI signing cert SHA1:       #{found || '(unknown)'}\n" \
          "ONE-TIME FIX: In Play Console -> Integridade do app -> Assinatura de apps -> 'Solicitar redefinicao da chave de upload', " \
          "upload the certificate that matches the CI keystore.\n" \
          "Tip: this workflow exports the CI upload cert as an artifact: android-artifacts/upload-cert.pem"
        )
      end
      if msg.include?(error_marker)
        if attempt < max_attempts
          UI.important(
            "Play upload key reset still propagating. Waiting #{sleep_seconds}s before retrying " \
            "(attempt #{attempt + 1}/#{max_attempts})."
          )
          sleep(sleep_seconds)
          attempt += 1
          retry
        end

        UI.important(
          "Play is still rejecting AAB uploads due to a recent upload key reset. " \
          "This is a Play Console propagation delay. Wait and rerun the workflow later."
        )
      end
      raise
    end
  end

  desc "Upload signed AAB to internal track"
  lane :internal do
    ENV["PLAY_TRACK"] = "internal"
    upload
  end

  desc "Upload signed AAB to production track"
  lane :production do
    ENV["PLAY_TRACK"] = "production"
    upload
  end

  desc "Promote an existing track release to production (safe default: internal -> production)"
  lane :promote_to_production do
    from_track = ENV["PLAY_TRACK"] || "internal"
    promote_status = ENV["PLAY_PROMOTE_RELEASE_STATUS"] || (ENV["PLAY_RELEASE_STATUS"] || "completed")

    supply(
      json_key: ENV.fetch("PLAY_JSON_KEY_PATH"),
      package_name: ENV.fetch("PLAY_PACKAGE_NAME"),
      track: from_track,
      track_promote_to: "production",
      track_promote_release_status: promote_status,
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true
    )
  end
end
